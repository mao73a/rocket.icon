<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket.Chat Message Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .search-container {
            max-width: 600px;
            margin: 100px auto;
        }
        .search-title {
            font-size: 2.5rem;
            color: #007bff;
            margin-bottom: 30px;
        }
        .results-container {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-container text-center">
            <h1 class="search-title">Rocket.Chat Message Search</h1>
            <form id="searchForm">
                <div class="input-group mb-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="Enter search text">
                    <button class="btn btn-primary" type="submit" id="searchButton">Search</button>
                </div>
            </form>
            <div id="resultsContainer" class="results-container"></div>
        </div>
    </div>

    <script>
        const ROCKET_CHAT_URL = 'https://chat.czk.comarch.com'; // Replace with your actual Rocket.Chat server URL
        document.getElementById('searchButton').addEventListener('click', performSearch);

                document.addEventListener('DOMContentLoaded', function() {
            const searchForm = document.getElementById('searchForm');
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent the form from submitting traditionally
                performSearch();
            });
        });

        async function performSearch() {
            const searchText = document.getElementById('searchInput').value;
            if (!searchText) return;

            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

            try {
                const subscriptionsData = await getSubscriptions();
                console.log('Subscriptions data:', subscriptionsData);

                if (!subscriptionsData || !Array.isArray(subscriptionsData.subscriptions)) {
                    throw new Error('Invalid subscriptions data');
                }

                const subscriptions = subscriptionsData.subscriptions;
                const searchResults = await Promise.all(subscriptions.map(sub => searchRoom(sub.rid, searchText, sub.fname, sub.t)));
                displayResults(searchResults.flat());
            } catch (error) {
                console.error('Error:', error);
                resultsContainer.innerHTML = `<div class="alert alert-danger" role="alert">An error occurred while searching: ${error.message}</div>`;
            }
        }

        async function getSubscriptions() {
            const response = await fetch('/api/subscriptions');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }
 
 

        async function searchRoom(roomId, searchText, roomName, roomType) {
            const response = await fetch(`/api/search?roomId=${encodeURIComponent(roomId)}&searchText=${encodeURIComponent(searchText)}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.messages ? data.messages.map(msg => ({
                ...msg,
                roomName: roomName || 'Unknown Room',
                roomType: roomType
            })) : [];
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('resultsContainer');
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-info" role="alert">No results found.</div>';
                return;
            }

            const resultHtml = results.map(result => {
                const channelType = result.roomType === 'd' ? 'direct' : 'group';
                const messageUrl = `${ROCKET_CHAT_URL}/${channelType}/${result.rid}?msg=${result._id}`;
                const messageDate = new Date(result.ts).toLocaleString();
                
                return `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">${escapeHtml(result.roomName)}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">
                            ${escapeHtml(result.u.name)} - 
                            <a href="${messageUrl}" target="_blank" rel="noopener noreferrer">${messageDate}</a>
                        </h6>
                        <p class="card-text">${escapeHtml(result.msg)}</p>
                    </div>
                </div>
            `}).join('');

            resultsContainer.innerHTML = resultHtml;
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>